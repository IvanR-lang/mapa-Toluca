<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Reportes Toluca</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #1a1a1a; color: white; }
        #map { height: 85vh; width: 100%; border-bottom: 3px solid #4CAF50; }
        .panel { padding: 10px; text-align: center; background: #333; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        h1 { margin: 5px 0; color: #4CAF50; font-size: 1.4rem; }
        p { margin: 2px; font-size: 0.9rem; color: #bbb; }
    </style>
</head>
<body>
    <div class="panel">
        <h1> Reportes Viales Toluca</h1>
        <p>Toca el mapa para reportar. 隆Se actualiza solo cada 4 segundos!</p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. Configuraci贸n Inicial del Mapa (Centrado en Toluca)
        const map = L.map('map').setView([19.2827, -99.6557], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let marcadoresActuales = [];

        // 2. Funci贸n para cargar puntos con EMOJIS DE TEXTO
        async function cargarPuntos() {
            try {
                const res = await fetch('/api/chat');
                const puntos = await res.json();
                
                // Limpiar mapa antes de actualizar
                marcadoresActuales.forEach(m => map.removeLayer(m));
                marcadoresActuales = [];

                puntos.forEach(p => {
                    if(p.lat && p.lng) {
                        // L贸gica de Emojis seg煤n el texto
                        let emoji = "";
                        if (p.texto.includes("RETN")) emoji = "";
                        if (p.texto.includes("ACCIDENTE")) emoji = "";
                        if (p.texto.includes("AVISO")) emoji = "锔";

                        // Creamos el icono de texto
                        const iconoEmoji = L.divIcon({
                            html: `<div style="font-size: 24px; filter: drop-shadow(0 0 2px black);">${emoji}</div>`,
                            className: 'custom-div-icon',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });

                        const m = L.marker([p.lat, p.lng], { icon: iconoEmoji })
                                  .addTo(map)
                                  .bindPopup(`<b>${p.texto}</b>`);
                        marcadoresActuales.push(m);
                    }
                });
            } catch (e) { console.log("Error de conexi贸n"); }
        }

        // 3. Sistema de Reporte
        map.on('click', async function(e) {
            const { lat, lng } = e.latlng;
            const nombre = prompt("驴Qui茅n reporta?");
            if (!nombre) return;

            const tipo = prompt("Elige: (1) RETN , (2) ACCIDENTE , (3) OTRO 锔");
            let textoFinal = "";

            if (tipo === "1") {
                textoFinal = ` RETN: Reportado por ${nombre}`;
            } else if (tipo === "2") {
                textoFinal = ` ACCIDENTE: Reportado por ${nombre}`;
            } else {
                textoFinal = `锔 AVISO: ${nombre} reporta precauci贸n`;
            }

            await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texto: textoFinal, lat: lat, lng: lng })
            });
            
            cargarPuntos(); 
        });

        // 4. Actualizaci贸n autom谩tica
        setInterval(cargarPuntos, 4000); 
        cargarPuntos();
    </script>
</body>
</html>