<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Reportes Toluca</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #1a1a1a; color: white; }
        #map { height: 85vh; width: 100%; border-bottom: 3px solid #4CAF50; }
        .panel { padding: 10px; text-align: center; background: #333; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        h1 { margin: 5px 0; color: #4CAF50; font-size: 1.4rem; }
        
        /* Estilo para el bot贸n de ubicaci贸n */
        .btn-ubicacion {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 25px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="panel">
        <h1> Reportes Viales Toluca</h1>
    </div>

    <button class="btn-ubicacion" onclick="buscarMiUbicacion()"></button>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([19.2827, -99.6557], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let marcadoresActuales = [];

        // FUNCIN NUEVA: Buscar ubicaci贸n del usuario
        function buscarMiUbicacion() {
            map.locate({setView: true, maxZoom: 16});
        }

        // Si se encuentra la ubicaci贸n, poner un c铆rculo azul donde est谩s
        map.on('locationfound', function(e) {
            L.circle(e.latlng, {radius: 100, color: '#4CAF50'}).addTo(map)
             .bindPopup("Est谩s aqu铆").openPopup();
        });

        map.on('locationerror', function() {
            alert("No pude acceder a tu ubicaci贸n. Revisa los permisos.");
        });

        async function cargarPuntos() {
            try {
                const res = await fetch('/api/chat');
                const puntos = await res.json();
                marcadoresActuales.forEach(m => map.removeLayer(m));
                marcadoresActuales = [];

                puntos.forEach(p => {
                    if(p.lat && p.lng) {
                        let emoji = "";
                        if (p.texto.includes("RETN")) emoji = "";
                        if (p.texto.includes("ACCIDENTE")) emoji = "";
                        if (p.texto.includes("AVISO")) emoji = "锔";

                        const iconoEmoji = L.divIcon({
                            html: `<div style="font-size: 24px; filter: drop-shadow(0 0 2px black);">${emoji}</div>`,
                            className: 'custom-div-icon',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });

                        const m = L.marker([p.lat, p.lng], { icon: iconoEmoji })
                                  .addTo(map)
                                  .bindPopup(`<b>${p.texto}</b>`);
                        marcadoresActuales.push(m);
                    }
                });
            } catch (e) { console.log("Error"); }
        }

        map.on('click', async function(e) {
            const { lat, lng } = e.latlng;
            const nombre = prompt("驴Qui茅n reporta?");
            if (!nombre) return;
            const tipo = prompt("Elige: (1) RETN , (2) ACCIDENTE , (3) OTRO 锔");
            let textoFinal = "";
            if (tipo === "1") textoFinal = ` RETN: Reportado por ${nombre}`;
            else if (tipo === "2") textoFinal = ` ACCIDENTE: Reportado por ${nombre}`;
            else textoFinal = `锔 AVISO: ${nombre} reporta precauci贸n`;

            await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texto: textoFinal, lat: lat, lng: lng })
            });
            cargarPuntos(); 
        });

        setInterval(cargarPuntos, 4000); 
        cargarPuntos();
    </script>
</body>
</html>
