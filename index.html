<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Toluca</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 0; background: #1a1a1a; color: white; overflow: hidden; }
        #map { height: 75vh; width: 100%; }
        
        .menu-reporte {
            height: 25vh;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 10px;
            background: #222;
        }

        .btn-accion {
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .btn-reten { background: #d32f2f; }
        .btn-accidente { background: #f57c00; }
        .btn-otro { background: #388e3c; }
        .btn-ubicacion {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 20px;
        }

        .emoji-grande { font-size: 2rem; }
    </style>
</head>
<body>

    <button class="btn-ubicacion" onclick="buscarMiUbicacion()">üéØ</button>
    
    <div id="map"></div>

    <div class="menu-reporte">
        <button class="btn-accion btn-reten" onclick="reportar('üö® RET√âN')">
            <span class="emoji-grande">üö®</span><span>RET√âN</span>
        </button>
        <button class="btn-accion btn-accidente" onclick="reportar('üí• CHOQUE')">
            <span class="emoji-grande">üí•</span><span>CHOQUE</span>
        </button>
        <button class="btn-accion btn-otro" onclick="reportar('‚ö†Ô∏è AVISO')">
            <span class="emoji-grande">‚ö†Ô∏è</span><span>AVISO</span>
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([19.2827, -99.6557], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let marcadoresActuales = [];
        let miUbicacion = null;

        // Rastrear ubicaci√≥n constantemente
        map.locate({watch: true, setView: false});
        map.on('locationfound', (e) => { miUbicacion = e.latlng; });

        function buscarMiUbicacion() {
            if(miUbicacion) map.setView(miUbicacion, 16);
        }

        async function reportar(tipo) {
            // Si no tenemos ubicaci√≥n, pedimos tocar el mapa
            let coords = miUbicacion;
            if (!coords) {
                alert("Esperando se√±al GPS o toca el mapa para marcar.");
                return;
            }

            await enviarDatos(tipo, coords.lat, coords.lng);
        }

        // Tambi√©n permite tocar el mapa para reportar en un punto espec√≠fico
        map.on('click', (e) => {
            const tipo = prompt("Escribe el reporte (Ej: Ret√©n, Bache, etc):");
            if(tipo) enviarDatos(tipo.toUpperCase(), e.latlng.lat, e.latlng.lng);
        });

        async function enviarDatos(texto, lat, lng) {
            await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texto, lat, lng })
            });
            cargarPuntos();
        }

        async function cargarPuntos() {
            try {
                const res = await fetch('/api/chat');
                const puntos = await res.json();
                marcadoresActuales.forEach(m => map.removeLayer(m));
                
                puntos.forEach(p => {
                    if(p.lat && p.lng) {
                        let emoji = "üìç";
                        if (p.texto.includes("RET√âN")) emoji = "üö®";
                        if (p.texto.includes("CHOQUE")) emoji = "üí•";
                        if (p.texto.includes("AVISO")) emoji = "‚ö†Ô∏è";

                        const icono = L.divIcon({
                            html: `<div style="font-size: 24px;">${emoji}</div>`,
                            className: 'dummy',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });

                        const m = L.marker([p.lat, p.lng], { icon: icono }).addTo(map);
                        marcadoresActuales.push(m);
                    }
                });
            } catch (e) {}
        }

        setInterval(cargarPuntos, 4000);
        cargarPuntos();
    </script>
</body>
</html>
