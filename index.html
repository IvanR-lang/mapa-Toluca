<script>
    // --- FUNCIÓN PIP LITE (CORREGIDA PARA EVITAR CONFLICTOS) ---
    async function handlePiP() {
        if ('documentPictureInPicture' in window) {
            try {
                // Pedimos una ventana con dimensiones fijas para no estresar al sistema
                const pipWin = await window.documentPictureInPicture.requestWindow({ 
                    width: 300, 
                    height: 300 
                });
                
                const mapContainer = document.getElementById('map');
                
                // En lugar de copiar TODO el CSS, solo inyectamos lo vital para el mapa
                const style = document.createElement('style');
                style.textContent = `
                    body { margin: 0; overflow: hidden; background: #1a1a1a; }
                    #map { height: 100vh; width: 100%; }
                    .leaflet-control-container { display: none; } /* Ocultamos controles para ahorrar RAM */
                `;
                pipWin.document.head.appendChild(style);
                pipWin.document.body.appendChild(mapContainer);
                
                alertarVoz("Mini mapa activo.");
                
                pipWin.addEventListener('pagehide', () => {
                    document.body.appendChild(mapContainer);
                    map.invalidateSize();
                });
                return;
            } catch(e) {
                console.log("Error al abrir PiP");
            }
        }
        alertarVoz("Tu dispositivo no soporta esta función.");
    }
</script>
